{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add/Edit Job with Skills 2</title>
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <style>
        .toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-toggle {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider-toggle:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider-toggle {
            background-color: #2196F3;
        }

        input:checked + .slider-toggle:before {
            transform: translateX(26px);
        }

        #toggle-label {
            margin-left: 10px;
            font-size: 16px;
            vertical-align: middle;
        }

        .slider-container {
            margin-bottom: 20px;
        }

        .slider {
            width: 100%;
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .slider-months-container {
            display: inline;
        }
    </style>
</head>
<body>
    <h1>{% if job_id %}Edit Job{% else %}Add Job{% endif %}</h1>

    <label class="toggle">
        <input type="checkbox" id="toggle-increment">
        <span class="slider-toggle"></span>
        <span id="toggle-label">Increment by Years</span>
    </label>

    <form method="POST" novalidate>
        {% csrf_token %}
        <div class="selected-job">
            <h3>Selected Job: {{ job.name }}</h3>
            <input type="hidden" name="job_id" value="{{ job.id }}">
        </div>

        {{ job_form.as_p }}

        <h3>Skills</h3>
        <table id="formset-container">
            {{ formset.management_form }}
            <thead>
                <tr>
                    <th>Skill</th>
                    <th>Years of Experience</th>
                </tr>
            </thead>
            <tbody>
                {% for form in formset %}
                <tr class="form-row">
                    {{ form.id }}
                    <td class="form-group">
                        {{ form.skill }}
                        {% if form.skill.errors %}
                            <div class="error-message">{{ form.skill.errors }}</div>
                        {% endif %}
                    </td>
                    <td class="form-group">
                        <div class="slider-container">
                            <!-- Slider for controlling the years and months -->
                            <input type="range" min="0" max="120" class="slider" id="slider-{{ forloop.counter0 }}">
                            
                            <!-- Hidden inputs for skill years and months -->
                            <input type="number" name="form-{{ forloop.counter0 }}-skill_years" id="id_form-{{ forloop.counter0 }}-skill_years" value="{{ form.skill_years.value|default_if_none:0 }}" hidden>
                            <input type="number" name="form-{{ forloop.counter0 }}-skill_months" id="id_form-{{ forloop.counter0 }}-skill_months" value="{{ form.skill_months.value|default_if_none:0 }}" hidden>

                            <div class="slider-value">
                                <span>Years: <span class="slider-years">{{ form.skill_years.value|default_if_none:0 }}</span></span>
                                <span class="slider-months-container">Months: <span class="slider-months">{{ form.skill_months.value|default_if_none:0 }}</span></span>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button type="submit">Save</button>
    </form>

    <script>
        const sliders = document.querySelectorAll('.slider');
        const toggleIncrement = document.getElementById('toggle-increment');
        const toggleLabel = document.getElementById('toggle-label');
        let incrementByYears = true;

        toggleIncrement.addEventListener('change', function () {
            incrementByYears = !incrementByYears;

            sliders.forEach((slider) => {
                const yearsDisplay = slider.parentElement.querySelector('.slider-years');
                const monthsDisplay = slider.parentElement.querySelector('.slider-months');
                let sliderValue = parseInt(slider.value);

                if (incrementByYears) {
                    slider.max = 10;
                    slider.value = Math.floor(sliderValue / 12);
                    yearsDisplay.textContent = slider.value;
                    monthsDisplay.textContent = 0;
                    document.querySelectorAll('.slider-months-container').forEach(container => container.style.display = 'none');
                    toggleLabel.textContent = "Increment by Years";
                } else {
                    slider.max = 120;
                    slider.value = sliderValue * 12;
                    yearsDisplay.textContent = Math.floor(slider.value / 12);
                    monthsDisplay.textContent = slider.value % 12;
                    document.querySelectorAll('.slider-months-container').forEach(container => container.style.display = 'inline');
                    toggleLabel.textContent = "Increment by Months";
                }
            });
        });

        sliders.forEach((slider, index) => {
            slider.oninput = function () {
                const yearsDisplay = this.parentElement.querySelector('.slider-years');
                const monthsDisplay = this.parentElement.querySelector('.slider-months');
                let sliderValue = parseInt(this.value);

                if (!incrementByYears) {
                    const years = Math.floor(sliderValue / 12);
                    const months = sliderValue % 12;
                    yearsDisplay.textContent = years;
                    monthsDisplay.textContent = months;

                    // Update hidden inputs
                    document.getElementById(`id_form-${index}-skill_years`).value = years;
                    document.getElementById(`id_form-${index}-skill_months`).value = months;
                } else {
                    yearsDisplay.textContent = sliderValue;
                    monthsDisplay.textContent = 0;

                    // Update hidden inputs
                    document.getElementById(`id_form-${index}-skill_years`).value = sliderValue;
                    document.getElementById(`id_form-${index}-skill_months`).value = 0;
                }
            };
        });
    </script>
</body>
</html>
